service: projetovida-api

frameworkVersion: '3'

provider:
  name: aws
  region: us-east-1
  stage: ${opt:stage, 'prod'}
  memorySize: 512
  timeout: 29
  ecr:
    images:
      appimage:
        path: ./
  
  environment:
    S3_BUCKET: projeto-vida-prd
    S3_KEY_PREFIX: dashboard_files
    DB_SECRET_NAME: projeto-vida/database
    COGNITO_SECRET_NAME: projeto-vida/cognito
    STAGE: ${self:provider.stage}
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
            - s3:HeadObject
          Resource: "arn:aws:s3:::projeto-vida-prd/*"
          
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource: "arn:aws:secretsmanager:${self:provider.region}:*:secret:projeto-vida/*"
          
        - Effect: Allow
          Action:
            - ec2:CreateNetworkInterface
            - ec2:DescribeNetworkInterfaces
            - ec2:DeleteNetworkInterface
            - ec2:AssignPrivateIpAddresses
            - ec2:UnassignPrivateIpAddresses
          Resource: "*"

        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"
  
  vpc:
    securityGroupIds:
      - sg-010ebae9343e8f422
    subnetIds:
      - subnet-0fcb4e5a4433397c3
      - subnet-045bdd15a0355fdbc

functions:
  api:
    image:
      name: appimage
    name: ProjetoVidaAPI
    events:
      - httpApi:
          path: /
          method: ANY
          cors:
            allowedOrigins:
              - https://master.d1yi28nqqe44f2.amplifyapp.com
              - http://localhost:5173
            allowedHeaders:
              - Content-Type
              - Authorization
              - X-Requested-With
              - X-CSRF-Token
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowCredentials: true
            maxAge: 1800
      - httpApi:
          path: /{proxy+}
          method: ANY
          cors:
            allowedOrigins:
              - https://master.d1yi28nqqe44f2.amplifyapp.com
              - http://localhost:5173
            allowedHeaders:
              - Content-Type
              - Authorization
              - X-Requested-With
              - X-CSRF-Token
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowCredentials: true
            maxAge: 1800
